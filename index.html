<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ArbScout ‚Äî Scanner de Arbitraje</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#07090f;--bg2:#0d1117;--bg3:#131922;--bg4:#1a2233;--bg5:#212d40;
  --border:#1c2a3a;--border2:#283848;--border-h:#334466;
  --accent:#00e676;--accent-dim:rgba(0,230,118,.12);--accent-mid:rgba(0,230,118,.25);
  --red:#ff5252;--red-dim:rgba(255,82,82,.1);
  --amber:#ffab00;--amber-dim:rgba(255,171,0,.1);
  --blue:#448aff;--blue-dim:rgba(68,138,255,.1);
  --purple:#b388ff;
  --text:#e8edf5;--text2:#a0b0c8;--muted:#5a7090;
  --font:'DM Mono',monospace;--display:'Outfit',sans-serif;
  --radius:10px;--radius-sm:6px;
}
html{background:var(--bg);color:var(--text);font-family:var(--font);-webkit-tap-highlight-color:transparent}
body{background:var(--bg);margin:0;overflow-x:hidden}
input,button,select{font-family:inherit}
.app{max-width:460px;margin:0 auto;min-height:100dvh;display:flex;flex-direction:column;position:relative}

/* ‚ïê‚ïê‚ïê SETUP ‚ïê‚ïê‚ïê */
.setup{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:32px 20px;gap:24px;background:radial-gradient(ellipse at 50% 0%,rgba(0,230,118,.04) 0%,transparent 60%)}
.logo-xl{font-family:var(--display);font-size:48px;font-weight:900;letter-spacing:-1px;color:var(--accent);line-height:1}
.logo-xl span{color:var(--text)}
.setup-sub{font-size:11px;color:var(--muted);letter-spacing:3px;text-transform:uppercase}
.features{display:flex;flex-direction:column;gap:8px;width:100%;max-width:360px}
.feat{display:flex;align-items:center;gap:12px;font-size:12px;color:var(--text2);line-height:1.4}
.feat-dot{width:6px;height:6px;border-radius:50%;background:var(--accent);flex-shrink:0;box-shadow:0 0 8px rgba(0,230,118,.4)}
.card-setup{width:100%;max-width:360px;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:20px;display:flex;flex-direction:column;gap:12px}
.inp-label{font-size:9px;color:var(--muted);letter-spacing:2px;text-transform:uppercase}
.inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:13px 14px;font-size:13px;color:var(--text);outline:none;transition:border-color .2s}
.inp:focus{border-color:var(--blue)}
.inp::placeholder{color:var(--muted)}
.btn-go{width:100%;padding:14px;background:var(--accent);border:none;border-radius:var(--radius-sm);font-family:var(--display);font-size:17px;font-weight:800;letter-spacing:1px;text-transform:uppercase;color:#000;cursor:pointer;transition:opacity .15s,transform .1s}
.btn-go:hover{opacity:.9}.btn-go:active{transform:scale(.98)}.btn-go:disabled{opacity:.45;cursor:default;transform:none}
.err-box{background:var(--red-dim);border:1px solid rgba(255,82,82,.25);border-radius:var(--radius-sm);padding:10px 14px;font-size:11px;color:var(--red);display:none;line-height:1.6}
.info-text{font-size:10px;color:var(--muted);text-align:center;line-height:1.8}
.info-text a{color:var(--blue);text-decoration:none}
.diag{background:var(--bg3);border:1px solid var(--border2);border-radius:var(--radius-sm);padding:12px;font-size:9px;color:var(--muted);line-height:2.2;width:100%;max-width:360px;display:none;max-height:200px;overflow-y:auto}
.diag .ok{color:var(--accent)}.diag .err{color:var(--red)}.diag .warn{color:var(--amber)}

/* ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê */
.hdr{position:sticky;top:0;z-index:60;background:var(--bg);border-bottom:1px solid var(--border)}
.hdr-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
.logo{font-family:var(--display);font-size:24px;font-weight:900;letter-spacing:-.5px;color:var(--accent);user-select:none}
.logo span{color:var(--text)}
.hdr-actions{display:flex;align-items:center;gap:6px}
.btn-icon{width:32px;height:32px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg3);color:var(--text2);cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.btn-icon:hover{border-color:var(--border-h);color:var(--text)}
.btn-sm{display:flex;align-items:center;gap:5px;padding:6px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:10px;cursor:pointer;transition:all .15s;white-space:nowrap}
.btn-sm:hover{border-color:var(--border-h);color:var(--text)}
.btn-sm:disabled{opacity:.4;cursor:default}
.btn-sm .si{display:inline-block}
.btn-sm.loading .si{animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.tabs{display:flex;border-top:1px solid var(--border)}
.tab-btn{flex:1;padding:10px;background:transparent;border:none;border-bottom:2px solid transparent;cursor:pointer;font-family:var(--display);font-size:13px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);transition:all .2s}
.tab-btn.active{color:var(--accent);border-bottom-color:var(--accent)}

/* ‚ïê‚ïê‚ïê BUDGET BAR ‚ïê‚ïê‚ïê */
.budget{display:flex;align-items:center;gap:8px;padding:6px 14px;background:var(--bg2);border-bottom:1px solid var(--border);font-size:9px}
.budget-bar{flex:1;height:4px;border-radius:2px;background:var(--bg5);overflow:hidden}
.budget-fill{height:100%;border-radius:2px;transition:width .3s}
.budget-text{color:var(--muted);white-space:nowrap}

/* ‚ïê‚ïê‚ïê SCAN MODE ‚ïê‚ïê‚ïê */
.scan-mode{display:flex;gap:6px;padding:8px 14px;background:var(--bg2);border-bottom:1px solid var(--border)}
.scan-opt{flex:1;padding:8px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg3);cursor:pointer;text-align:center;transition:all .15s}
.scan-opt.active{border-color:var(--accent);background:var(--accent-dim)}
.scan-opt-t{font-family:var(--display);font-size:13px;font-weight:700;color:var(--text)}
.scan-opt.active .scan-opt-t{color:var(--accent)}
.scan-opt-d{font-size:8px;color:var(--muted);margin-top:2px}
.scan-opt-c{font-size:9px;color:var(--amber);margin-top:3px;font-weight:600}

/* ‚ïê‚ïê‚ïê STATS ‚ïê‚ïê‚ïê */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);background:var(--bg2);border-bottom:1px solid var(--border)}
.stat-cell{text-align:center;padding:8px 4px;border-right:1px solid var(--border)}
.stat-cell:last-child{border-right:none}
.stat-val{font-family:var(--display);font-size:20px;font-weight:800;line-height:1}
.stat-lbl{font-size:7px;letter-spacing:1.5px;color:var(--muted);margin-top:3px;text-transform:uppercase}

/* ‚ïê‚ïê‚ïê STATUS ‚ïê‚ïê‚ïê */
.status{display:flex;align-items:center;justify-content:space-between;padding:5px 14px;background:var(--bg3);border-bottom:1px solid var(--border);font-size:9px;color:var(--muted);gap:8px}
.status-left{display:flex;align-items:center;gap:6px;min-width:0;overflow:hidden}
.dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.dot.ok{background:var(--accent);box-shadow:0 0 6px rgba(0,230,118,.5)}
.dot.loading{background:var(--amber);animation:pulse 1s infinite}
.dot.error{background:var(--red)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
.status-text{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* ‚ïê‚ïê‚ïê CHIPS & FILTERS ‚ïê‚ïê‚ïê */
.chips-row{display:flex;gap:5px;padding:8px 14px;background:var(--bg2);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.chips-row::-webkit-scrollbar{display:none}
.chip{padding:4px 12px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--muted);font-size:11px;cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0}
.chip.active{background:var(--blue-dim);border-color:var(--blue);color:var(--blue)}
.chip .cc{font-size:9px;opacity:.7;margin-left:3px}
.filter-row{display:flex;align-items:center;gap:5px;padding:6px 14px;background:var(--bg2);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.filter-row::-webkit-scrollbar{display:none}
.flbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;white-space:nowrap;flex-shrink:0}
.sort-btn{display:inline-flex;align-items:center;gap:3px;padding:4px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-size:10px;cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0}
.sort-btn.desc{border-color:var(--amber);color:var(--amber);background:var(--amber-dim)}
.sort-btn.asc{border-color:#ff9100;color:#ff9100;background:rgba(255,145,0,.08)}
.arb-toggle{margin-left:auto;padding:4px 11px;border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;color:var(--muted);font-size:10px;cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0}
.arb-toggle.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}

/* ‚ïê‚ïê‚ïê STAKE ‚ïê‚ïê‚ïê */
.stake-row{display:flex;align-items:center;gap:5px;padding:6px 14px;background:var(--bg2);border-bottom:1px solid var(--border);overflow-x:auto;scrollbar-width:none}
.stake-row::-webkit-scrollbar{display:none}
.stake-lbl{font-size:10px;color:var(--muted);font-weight:600;flex-shrink:0}
.schip{padding:4px 12px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg3);color:var(--text2);font-family:var(--display);font-size:14px;font-weight:700;cursor:pointer;white-space:nowrap;transition:all .15s;flex-shrink:0}
.schip.active{background:var(--accent-dim);border-color:var(--accent);color:var(--accent)}
.sinp2{width:65px;padding:4px 8px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg3);color:var(--text);font-size:11px;text-align:center;outline:none;flex-shrink:0}
.sinp2.active{border-color:var(--accent)}
.meta-row{padding:4px 14px;font-size:9px;color:var(--muted);background:var(--bg);border-bottom:1px solid var(--border);display:flex;justify-content:space-between}
.meta-row strong{color:var(--text)}

/* ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê */
.content{flex:1;overflow-y:auto;padding:8px 8px 56px}

/* ‚ïê‚ïê‚ïê EVENT CARD ‚ïê‚ïê‚ïê */
.ev{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px;overflow:hidden;position:relative;transition:border-color .3s}
.ev.arb{border-color:rgba(0,230,118,.35)}
.ev-bar{position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--accent);opacity:0;transition:opacity .3s}
.ev.arb .ev-bar{opacity:1}
.ev-head{display:flex;align-items:flex-start;cursor:pointer;padding:9px 12px 7px;user-select:none}
.ev.arb .ev-head{padding-left:16px}
.ev-left{flex:1;min-width:0}
.ev-meta{display:flex;align-items:center;gap:5px;margin-bottom:2px;overflow:hidden}
.ev-tour{font-size:9px;color:var(--blue);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px}
.ev-sep{font-size:9px;color:var(--border2)}
.ev-time{font-size:9px;color:var(--text2);white-space:nowrap}
.ev-match{font-family:var(--display);font-size:15px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:-.2px}
.ev-sport{font-size:9px;color:var(--muted);margin-top:1px}
.ev-right{display:flex;flex-direction:column;align-items:flex-end;gap:3px;flex-shrink:0;margin-left:8px;padding-top:1px}
.badge-arb{background:var(--accent-dim);border:1px solid var(--accent-mid);border-radius:5px;padding:3px 8px;font-family:var(--display);font-size:14px;font-weight:800;color:var(--accent);white-space:nowrap}
.badge-none{background:rgba(90,112,144,.08);border:1px solid var(--border);border-radius:5px;padding:3px 7px;font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.ev-impl{font-size:9px;color:var(--muted);white-space:nowrap}
.ev.arb .ev-impl{color:rgba(0,230,118,.45)}
.ev-chev{font-size:9px;color:var(--muted);margin-left:5px;transition:transform .2s;flex-shrink:0;margin-top:4px}
.ev-chev.open{transform:rotate(180deg)}
.ev-odds{display:flex;gap:4px;padding:0 12px 8px}
.ev.arb .ev-odds{padding-left:16px}
.oc{flex:1;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:5px 4px;text-align:center;min-width:0}
.oc.best{border-color:var(--accent-mid)}
.oc-n{font-size:7px;color:var(--muted);text-transform:uppercase;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.oc-v{font-family:var(--display);font-size:15px;font-weight:800;color:var(--text)}
.oc.best .oc-v{color:var(--accent)}
.oc-b{font-size:7px;color:var(--muted);margin-top:1px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ‚ïê‚ïê‚ïê DETAIL ‚ïê‚ïê‚ïê */
.detail{border-top:1px solid var(--border);padding:12px;background:var(--bg3)}
.rbox{display:flex;align-items:center;justify-content:space-between;border-radius:var(--radius);padding:10px 14px;margin-bottom:10px}
.rbox.win{background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.2)}
.rbox.lose{background:rgba(90,112,144,.06);border:1px solid var(--border)}
.r-pct{font-family:var(--display);font-size:38px;font-weight:900;color:var(--accent);line-height:1}
.r-info{text-align:right}
.r-tag{font-size:8px;color:var(--accent);letter-spacing:2px;text-transform:uppercase}
.r-profit{font-family:var(--display);font-size:16px;font-weight:800;color:var(--accent);margin-top:2px}
.r-no{font-family:var(--display);font-size:14px;color:var(--muted);font-weight:700}
.r-mg{font-size:10px;color:var(--text2)}
.inv-row{display:flex;align-items:center;background:var(--bg4);border:1px solid var(--border2);border-radius:var(--radius);padding:8px 12px;margin-bottom:10px;gap:8px}
.inv-lbl{font-size:9px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;white-space:nowrap}
.inv-e{font-family:var(--display);font-size:16px;font-weight:700;color:var(--muted)}
.inv-i{flex:1;background:transparent;border:none;outline:none;font-size:18px;font-weight:600;color:var(--text);text-align:right;min-width:0}
.lgrid{display:flex;flex-direction:column;gap:6px}
.lc{background:var(--bg4);border:1px solid var(--border);border-radius:var(--radius);padding:8px 10px}
.lc-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}
.lc-name{font-family:var(--display);font-size:14px;font-weight:700}
.lc-odds{font-family:var(--display);font-size:19px;font-weight:900;color:var(--amber)}
.lc-book{font-size:8px;color:var(--muted);margin-bottom:5px}
.lc-amts{display:flex;gap:5px}
.la{flex:1;background:var(--bg5);border-radius:var(--radius-sm);padding:6px;text-align:center}
.la-v{font-family:var(--display);font-size:15px;font-weight:800}
.la-l{font-size:7px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-top:2px}
.la.s .la-v{color:var(--blue)}.la.r .la-v{color:var(--accent)}
.comp{margin-top:8px}
.comp-t{font-size:8px;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px}
.comp-r{display:flex;justify-content:space-between;align-items:center;padding:4px 9px;border-radius:var(--radius-sm);margin-bottom:3px;background:var(--bg5);border:1px solid var(--border)}
.comp-r.top{background:rgba(0,230,118,.05);border-color:rgba(0,230,118,.18)}
.comp-n{font-size:9px;color:var(--text2)}
.comp-o{font-family:var(--display);font-size:14px;font-weight:800;color:var(--text)}
.comp-r.top .comp-o{color:var(--accent)}
.ibox{background:rgba(68,138,255,.06);border:1px solid rgba(68,138,255,.15);border-radius:var(--radius-sm);padding:7px 10px;font-size:9px;color:var(--blue);line-height:1.7;margin-top:8px}

/* ‚ïê‚ïê‚ïê SKELETON ‚ïê‚ïê‚ïê */
.sk{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:6px;padding:14px;overflow:hidden;position:relative}
.sk::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg,transparent 20%,rgba(28,42,58,.6) 50%,transparent 80%);animation:shimmer 1.4s infinite}
@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
.sk-l{height:8px;border-radius:4px;background:var(--border2);margin-bottom:8px}
.sk-w{width:70%}.sk-m{width:45%}.sk-s{width:25%}
.sk-bx{display:flex;gap:5px;margin-top:10px}.sk-b{flex:1;height:44px;border-radius:var(--radius-sm);background:var(--border2)}

.empty{display:flex;flex-direction:column;align-items:center;padding:60px 24px;gap:14px;color:var(--muted);text-align:center}
.empty-icon{font-size:40px;opacity:.7}
.empty-text{font-size:12px;line-height:1.6;max-width:280px}

/* ‚ïê‚ïê‚ïê CALC ‚ïê‚ïê‚ïê */
.calc{padding:14px}
.calc-t{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:12px}
.calc-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:8px}
.calc-row{display:flex;gap:8px;margin-bottom:8px}
.calc-f{flex:1}
.calc-lbl{font-size:8px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;margin-bottom:4px}
.calc-inp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:7px 9px;font-size:11px;color:var(--text);outline:none}
.calc-inp:focus{border-color:var(--blue)}
.calc-oinp{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px;font-family:var(--display);font-size:26px;font-weight:800;color:var(--amber);text-align:center;outline:none}
.calc-oinp:focus{border-color:var(--amber)}
.calc-btns{display:flex;gap:8px;margin-bottom:12px}
.calc-btn{flex:1;padding:9px;border:none;cursor:pointer;border-radius:var(--radius);font-family:var(--display);font-size:12px;font-weight:700;letter-spacing:1px;text-transform:uppercase;transition:opacity .15s}
.calc-add{background:var(--bg3);border:1px solid var(--border);color:var(--text)}
.calc-del{background:var(--red-dim);border:1px solid rgba(255,82,82,.25);color:var(--red)}

/* ‚ïê‚ïê‚ïê TICKER ‚ïê‚ïê‚ïê */
.ticker{position:fixed;bottom:0;left:50%;transform:translateX(-50%);width:100%;max-width:460px;background:var(--bg2);border-top:1px solid var(--border);padding:6px 14px;font-size:9px;color:var(--muted);display:flex;align-items:center;justify-content:space-between;z-index:50}
.ticker-left{display:flex;align-items:center;gap:5px}
.ticker-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.ticker-dot.ok{background:var(--accent)}.ticker-dot.loading{background:var(--amber);animation:pulse 1s infinite}
.auto-btn{padding:3px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;color:var(--muted);font-size:9px;cursor:pointer;transition:all .15s;white-space:nowrap}
.auto-btn.on{border-color:var(--accent);color:var(--accent)}
.content::-webkit-scrollbar{width:3px}.content::-webkit-scrollbar-track{background:transparent}.content::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px}
</style>
</head>
<body>
<div id="app" class="app"></div>
<script>
const API="https://api.the-odds-api.com/v4";
// Only DGOJ-licensed bookmakers that exist in The Odds API
const ES_BOOKS={
  williamhill:"William Hill",
  betfair_ex_eu:"Betfair Exchange",
  betfair_sb_uk:"Betfair SB",
  sport888:"888sport",
  onexbet:"1xBet",
  betsson:"Betsson",
  betway:"Betway",
  leovegas:"LeoVegas",
  casumo:"Casumo"
};
function classifyKey(k){if(k.startsWith("soccer"))return"soccer";if(k.startsWith("tennis"))return"tennis";return"other"}
const GLBL={all:"Todos",soccer:"‚öΩ F√∫tbol",tennis:"üéæ Tenis",other:"üèÄ Otros"};
const GICON={soccer:"‚öΩ",tennis:"üéæ",other:"üèÄ"};
const TITLES={};
const TOP_SPORTS=["soccer_spain_la_liga","soccer_epl","soccer_uefa_champs_league","soccer_germany_bundesliga","soccer_italy_serie_a","soccer_france_ligue_one","tennis_atp_aus_open","tennis_atp_french_open","tennis_atp_us_open","tennis_atp_wimbledon","basketball_nba","basketball_euroleague","icehockey_nhl","mma_mixed_martial_arts"];

const S={
  key:localStorage.getItem("arb_key")||"",ok:!!localStorage.getItem("arb_key"),
  events:[],loading:false,error:null,lastFetch:null,remaining:null,used:null,
  scanMode:localStorage.getItem("arb_mode")||"smart",allSportKeys:[],
  tab:"scanner",sportFilter:"all",showOnlyArb:false,
  sortKey:"profit",sortDir:"desc",expanded:null,
  stake:100,customStake:"",isCustom:false,detailStakes:{},
  autoRefresh:false,countdown:120,_timer:null,
  calcLegs:[{label:"Resultado 1",book:"William Hill",odds:""},{label:"Resultado 2",book:"888sport",odds:""}],
  calcStake:100,diagLog:[],sportCounts:{soccer:0,tennis:0,other:0}
};

// ‚ïê‚ïê‚ïê MATH ‚ïê‚ïê‚ïê
const calcArb=legs=>{const sum=legs.reduce((a,l)=>a+1/(parseFloat(l.odds)||1),0);return{sum,isArb:sum<1,profit:sum<1?((1-sum)/sum)*100:null}};
const calcStakes=(legs,tot)=>{const sum=legs.reduce((a,l)=>a+1/(parseFloat(l.odds)||1),0);return legs.map(l=>{const s=(tot*(1/parseFloat(l.odds)))/sum;return{...l,stake:+s.toFixed(2),payout:+(s*parseFloat(l.odds)).toFixed(2)}})};

// ‚ïê‚ïê‚ïê NETWORK ‚ïê‚ïê‚ïê
let fetchCtrl=null;
function fetchTO(url,ms=10000){
  return new Promise((resolve,reject)=>{
    const ac=new AbortController();
    const t=setTimeout(()=>{ac.abort();reject(new Error("Timeout"))},ms);
    if(fetchCtrl?.signal.aborted){clearTimeout(t);reject(new Error("Cancelado"));return}
    const onAbort=()=>{ac.abort();clearTimeout(t);reject(new Error("Cancelado"))};
    fetchCtrl?.signal.addEventListener("abort",onAbort,{once:true});
    fetch(url,{signal:ac.signal}).then(r=>{clearTimeout(t);resolve(r)}).catch(e=>{clearTimeout(t);reject(e)});
  });
}
async function apiGet(url){
  const strats=[u=>u,u=>"https://corsproxy.io/?"+encodeURIComponent(u)];
  let lastErr;
  for(const fn of strats){
    try{const r=await fetchTO(fn(url),10000);if(r.ok||[401,404,422,429].includes(r.status))return r}
    catch(e){lastErr=e;if(e.message==="Cancelado")throw e}
  }
  throw lastErr||new Error("Sin conexi√≥n");
}
function cancelFetch(){if(fetchCtrl){fetchCtrl.abort();fetchCtrl=null}S.loading=false;S.countdown=120;dlog("‚õî Cancelado","warn");render()}

// ‚ïê‚ïê‚ïê CACHE (5 min) ‚ïê‚ïê‚ïê
const CACHE_TTL=300000;
function cGet(k){try{const r=sessionStorage.getItem("a_"+k);if(!r)return null;const{d,t}=JSON.parse(r);if(Date.now()-t>CACHE_TTL){sessionStorage.removeItem("a_"+k);return null}return d}catch{return null}}
function cSet(k,d){try{sessionStorage.setItem("a_"+k,JSON.stringify({d,t:Date.now()}))}catch{}}

// ‚ïê‚ïê‚ïê FETCH SPORT ‚ïê‚ïê‚ïê
async function fetchSport(sk){
  const cached=cGet(sk);
  if(cached){dlog(`‚ö° ${TITLES[sk]||sk}: cache (${cached.length})`,"ok");return cached}
  const url=`${API}/sports/${sk}/odds/?apiKey=${S.key}&regions=eu,uk&markets=h2h&oddsFormat=decimal`;
  let res;try{res=await apiGet(url)}catch(e){dlog(`‚úó ${sk}: ${e.message}`,"err");return[]}
  // Try to read remaining (may be stripped by CORS proxy)
  try{const rem=res.headers.get("x-requests-remaining"),used=res.headers.get("x-requests-used");if(rem)S.remaining=parseInt(rem);if(used)S.used=parseInt(used)}catch{}
  if(res.status===401||res.status===429){
    // Read body to distinguish "invalid key" vs "quota exhausted"
    let body="";try{body=await res.text()}catch{}
    const isQuota=body.toLowerCase().includes("usage")||body.toLowerCase().includes("quota")||body.toLowerCase().includes("limit")||body.toLowerCase().includes("exceeded")||body.toLowerCase().includes("subscription");
    if(isQuota||res.status===429){dlog(`‚úó Cuota agotada (${res.status})`,"err");throw new Error("QUOTA_EXHAUSTED")}
    throw new Error("API key inv√°lida");
  }
  if(!res.ok||res.status===422||res.status===404)return[];
  const data=await res.json();if(!Array.isArray(data))return[];
  const events=[];
  for(const g of data){
    if(!g.bookmakers||g.bookmakers.length<2)continue;
    const oMap={};
    for(const bk of g.bookmakers){if(!ES_BOOKS[bk.key])continue;const h2h=bk.markets?.find(m=>m.key==="h2h");if(!h2h)continue;for(const oc of h2h.outcomes){if(!oMap[oc.name])oMap[oc.name]=[];oMap[oc.name].push({book:ES_BOOKS[bk.key],bookKey:bk.key,odds:oc.price})}}
    const names=Object.keys(oMap);if(names.length<2)continue;
    const legs=names.map(n=>{const opts=oMap[n].sort((a,b)=>b.odds-a.odds);return{label:n,odds:opts[0].odds,book:opts[0].book,bookKey:opts[0].bookKey,allOpts:opts}});
    const{sum,isArb,profit}=calcArb(legs);
    events.push({id:g.id,sportKey:sk,group:classifyKey(sk),sport:TITLES[sk]||sk,match:`${g.home_team} vs ${g.away_team}`,tournament:TITLES[sk]||sk,commence:g.commence_time,legs,isArb,profit,impliedSum:sum,bookCount:g.bookmakers.filter(b=>ES_BOOKS[b.key]).length});
  }
  cSet(sk,events);dlog(`‚úì ${TITLES[sk]||sk}: ${events.length} eventos`,"ok");return events;
}

// ‚ïê‚ïê‚ïê MAIN FETCH ‚ïê‚ïê‚ïê
async function fetchAll(){
  if(S.loading){cancelFetch();await sleep(200)}
  fetchCtrl=new AbortController();S.loading=true;S.error=null;S.diagLog=[];
  dlog("Consultando deportes activos‚Ä¶");render();
  const safety=setTimeout(()=>{if(S.loading){S.loading=false;S.error=S.error||"Timeout ‚Äî intenta de nuevo";S.lastFetch=new Date();updateCounts();render()}},45000);
  try{
    const sRes=await apiGet(`${API}/sports?apiKey=${S.key}&all=false`);
    if(sRes.status===401)throw new Error("API key inv√°lida");
    if(!sRes.ok)throw new Error(`Error ${sRes.status}`);
    try{const rem0=sRes.headers.get("x-requests-remaining"),used0=sRes.headers.get("x-requests-used");if(rem0)S.remaining=parseInt(rem0);if(used0)S.used=parseInt(used0)}catch{}

    const all=await sRes.json();
    all.forEach(s=>{TITLES[s.key]=s.title||s.key});
    S.allSportKeys=all.map(s=>s.key);

    // Early check if we know remaining is 0 or negative
    if(S.remaining!==null&&S.remaining<1){
      throw new Error("QUOTA_EXHAUSTED");
    }

    let toScan;
    if(S.scanMode==="smart"){
      toScan=S.allSportKeys.filter(k=>TOP_SPORTS.includes(k));
      if(toScan.length===0)toScan=S.allSportKeys.slice(0,8);
    }else{toScan=S.allSportKeys}

    const needFetch=toScan.filter(k=>!cGet(k)).length;
    const fromCache=toScan.length-needFetch;
    dlog(`${toScan.length} deportes (${fromCache} cache, ${needFetch} a consultar)`);

    // If we know remaining, limit
    if(S.remaining!==null&&S.remaining>0&&needFetch>S.remaining){
      dlog(`‚ö†Ô∏è Solo ${S.remaining} req ‚Äî limitando`,"warn");
      let count=0;toScan=toScan.filter(k=>{if(cGet(k))return true;if(count<S.remaining){count++;return true}return false});
    }

    // TEST FETCH: try ONE sport first to detect quota issues before batch
    if(needFetch>0){
      const testKey=toScan.find(k=>!cGet(k));
      if(testKey){
        dlog(`Probando conexi√≥n con ${TITLES[testKey]||testKey}‚Ä¶`);
        render();
        try{
          const testResult=await fetchSport(testKey);
          // It worked! Continue with rest
        }catch(e){
          if(e.message==="QUOTA_EXHAUSTED")throw e;
          if(e.message==="API key inv√°lida")throw e;
          // Other error ‚Äî try to continue anyway
          dlog(`‚ö†Ô∏è Test fall√≥: ${e.message} ‚Äî intentando resto‚Ä¶`,"warn");
        }
      }
    }
    render();

    // Fetch remaining sports in batches
    const BATCH=3,DELAY=500;const allEv=[];
    let consecutiveFails=0;

    for(let i=0;i<toScan.length;i+=BATCH){
      if(fetchCtrl?.signal.aborted)break;
      if(consecutiveFails>=6){
        dlog("‚õî Demasiados fallos seguidos ‚Äî abortando","err");
        break;
      }
      const batch=toScan.slice(i,i+BATCH);
      const results=await Promise.allSettled(batch.map(k=>fetchSport(k)));

      let batchOk=0;
      for(const r of results){
        if(r.status==="fulfilled"){allEv.push(...r.value);if(r.value.length>0)batchOk++;consecutiveFails=0}
        else if(r.reason?.message==="QUOTA_EXHAUSTED"){throw r.reason}
        else if(r.reason?.message==="Cancelado"){throw r.reason}
        else if(r.reason?.message==="RATE_LIMIT"){consecutiveFails+=3}
        else{consecutiveFails++}
      }
      // If entire batch returned 0 events (not just empty sports), count it
      if(batchOk===0&&batch.every(k=>!cGet(k)))consecutiveFails+=1;

      if(i+BATCH<toScan.length)await sleep(DELAY);
      S.events=[...allEv];updateCounts();render();
    }
    S.events=allEv;S.lastFetch=new Date();updateCounts();
    const arbs=allEv.filter(e=>e.isArb).length;
    dlog(`‚úÖ ${allEv.length} eventos ¬∑ ${arbs} arbs ¬∑ ${S.remaining!==null?S.remaining+' req':'cuota desconocida'}`,"ok");

  }catch(e){
    if(e.message==="QUOTA_EXHAUSTED"){
      S.error="‚ö†Ô∏è Cuota mensual agotada. Tu plan gratuito (500 req/mes) se ha consumido. Renueva en the-odds-api.com o espera al pr√≥ximo mes.";
      dlog("‚úó CUOTA AGOTADA ‚Äî 0 requests restantes","err");
      dlog("üí° Consejo: el plan Rookie ($20/mes) da 20.000 req","warn");
    }else if(e.message!=="Cancelado"){
      S.error=e.message;dlog(`ERROR: ${e.message}`,"err");
    }
  }
  clearTimeout(safety);fetchCtrl=null;S.loading=false;S.countdown=120;render();
}

function updateCounts(){S.sportCounts={soccer:0,tennis:0,other:0};for(const e of S.events){if(S.sportCounts[e.group]!==undefined)S.sportCounts[e.group]++}}
function sleep(ms){return new Promise(r=>setTimeout(r,ms))}
function dlog(msg,type){
  S.diagLog.push({msg,type:type||"info"});
  const el=document.getElementById("diagBox");
  if(el){el.style.display="block";el.innerHTML=S.diagLog.map(d=>`<div class="${d.type==='ok'?'ok':d.type==='err'?'err':d.type==='warn'?'warn':''}">${d.msg}</div>`).join("");el.scrollTop=el.scrollHeight}
}
function fmtTime(iso){try{const d=new Date(iso),m=(d-new Date())/60000;if(m<-60)return"Finalizado";if(m<0)return"üî¥ En curso";if(m<60)return`‚è± ${Math.round(m)}min`;if(m<1440)return d.toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"});return d.toLocaleDateString("es-ES",{weekday:"short",day:"numeric",month:"short"})}catch{return"‚Äî"}}
function minsUntil(iso){try{return(new Date(iso)-new Date())/60000}catch{return 9999}}
function getFiltered(){
  let list=[...S.events];
  if(S.sportFilter!=="all")list=list.filter(e=>e.group===S.sportFilter);
  if(S.showOnlyArb)list=list.filter(e=>e.isArb);
  list.sort((a,b)=>{let va,vb;if(S.sortKey==="profit"){va=a.isArb?(a.profit||0):-(a.impliedSum);vb=b.isArb?(b.profit||0):-(b.impliedSum)}else{va=minsUntil(a.commence);vb=minsUntil(b.commence)}return S.sortDir==="desc"?vb-va:va-vb});
  return list;
}

// ‚ïê‚ïê‚ïê TIMER ‚ïê‚ïê‚ïê
function startTimer(){if(S._timer)clearInterval(S._timer);S._timer=setInterval(()=>{if(!S.autoRefresh||S.loading)return;S.countdown--;const el=document.getElementById("tickTxt");if(el)el.textContent=tickTxt();if(S.countdown<=0)fetchAll()},1000)}
function tickTxt(){const a=S.events.filter(e=>e.isArb).length,t=S.lastFetch?S.lastFetch.toLocaleTimeString("es-ES"):"‚Äî";let s=`${a} arbs ¬∑ ${S.events.length} ev ¬∑ ${t}`;if(S.autoRefresh)s+=` ¬∑ ${S.countdown}s`;return s}

// ‚ïê‚ïê‚ïê RENDER ‚ïê‚ïê‚ïê
function render(){document.getElementById("app").innerHTML=S.ok?mainHTML():setupHTML();bindAll()}

function setupHTML(){return`<div class="setup">
<div class="logo-xl">Arb<span>Scout</span></div>
<div class="setup-sub">Scanner de Arbitraje</div>
<div class="features">
  <div class="feat"><div class="feat-dot"></div>Cuotas de 9 casas con licencia DGOJ</div>
  <div class="feat"><div class="feat-dot"></div>Modo r√°pido: solo ~8 req por escaneo</div>
  <div class="feat"><div class="feat-dot"></div>Cache 5 min ‚Äî no gasta req al recargar</div>
  <div class="feat"><div class="feat-dot"></div>Tu key se guarda solo en tu navegador</div>
</div>
<div class="card-setup">
  <div class="inp-label">The Odds API ‚Äî API Key</div>
  <input class="inp" id="keyInp" type="text" placeholder="Pega tu API key‚Ä¶" value="${S.key}" autocomplete="off" spellcheck="false">
  <button class="btn-go" id="connBtn">Conectar y Escanear</button>
  <div class="err-box" id="errBox"></div>
  <div class="info-text">Key gratis en <a href="https://the-odds-api.com" target="_blank">the-odds-api.com</a><br>Gratuito: 500 req/mes ¬∑ Plan $20/mes: 20K req</div>
</div>
<div class="diag" id="diagBox"></div>
</div>`}

function mainHTML(){return renderHdr()+(S.tab==="scanner"?renderScanner():renderCalc())+renderTicker()}

function renderHdr(){return`<div class="hdr">
<div class="hdr-row">
  <div class="logo">Arb<span>Scout</span></div>
  <div class="hdr-actions">
    <button class="btn-sm ${S.loading?'loading':''}" id="refBtn"><span class="si">‚Üª</span> ${S.loading?"Cancelar":"Escanear"}</button>
    <button class="btn-icon" id="logBtn" title="Desconectar">‚èª</button>
  </div>
</div>
<div class="tabs">
  <button class="tab-btn ${S.tab==='scanner'?'active':''}" data-tab="scanner">Scanner</button>
  <button class="tab-btn ${S.tab==='calculator'?'active':''}" data-tab="calculator">Calculadora</button>
</div>
</div>`}

function renderBudget(){
  if(S.remaining===null&&S.used===null)return"";
  const rem=S.remaining||0;const total=Math.max((rem)+(S.used||0),1);
  const pct=rem>0?Math.round((rem/total)*100):0;
  const color=rem<=0?"var(--red)":pct>30?"var(--accent)":"var(--amber)";
  const cls=rem<=0?"color:var(--red)":pct>30?"color:var(--accent)":"color:var(--amber)";
  return`<div class="budget"><span style="flex-shrink:0;font-weight:600;${cls}">${rem<=0?"‚ö†Ô∏è 0":""+rem} req</span><div class="budget-bar"><div class="budget-fill" style="width:${pct}%;background:${color}"></div></div><span class="budget-text">de ${total}</span></div>`
}

function renderScanMode(){
  const smartN=S.allSportKeys.filter(k=>TOP_SPORTS.includes(k)).length||"~8";
  const fullN=S.allSportKeys.length||"~35";
  return`<div class="scan-mode">
  <div class="scan-opt ${S.scanMode==='smart'?'active':''}" data-mode="smart">
    <div class="scan-opt-t">‚ö° R√°pido</div><div class="scan-opt-d">Ligas top</div><div class="scan-opt-c">~${smartN} req</div>
  </div>
  <div class="scan-opt ${S.scanMode==='full'?'active':''}" data-mode="full">
    <div class="scan-opt-t">üåç Completo</div><div class="scan-opt-d">Todo</div><div class="scan-opt-c">~${fullN} req</div>
  </div>
</div>`}

function renderScanner(){
  const disp=getFiltered(),arbs=S.events.filter(e=>e.isArb).length,best=S.events.filter(e=>e.isArb).sort((a,b)=>b.profit-a.profit)[0],sc=S.sportCounts;
  const sa=S.sortDir==="desc"?"‚Üì":"‚Üë";
  return`${renderBudget()}${renderScanMode()}
<div class="stats-row">
  <div class="stat-cell"><div class="stat-val" style="color:var(--accent)">${arbs}</div><div class="stat-lbl">Arbs</div></div>
  <div class="stat-cell"><div class="stat-val" style="color:var(--amber)">${best?"+"+best.profit.toFixed(1)+"%":"‚Äî"}</div><div class="stat-lbl">Mejor</div></div>
  <div class="stat-cell"><div class="stat-val" style="color:var(--blue)">${S.events.length}</div><div class="stat-lbl">Eventos</div></div>
  <div class="stat-cell"><div class="stat-val" style="color:var(--purple)">${disp.length}</div><div class="stat-lbl">Visibles</div></div>
</div>
<div class="status"><div class="status-left"><div class="dot ${S.loading?'loading':S.error?'error':'ok'}"></div><span class="status-text">${S.loading?"Escaneando‚Ä¶":S.error?S.error:S.lastFetch?`Actualizado ${S.lastFetch.toLocaleTimeString("es-ES")}`:"Pulsa Escanear"}</span></div></div>
<div class="chips-row">${Object.entries(GLBL).map(([k,l])=>{const c=k==="all"?S.events.length:(sc[k]||0);return`<button class="chip ${S.sportFilter===k?'active':''}" data-sport="${k}">${l}<span class="cc">${c}</span></button>`}).join("")}</div>
<div class="filter-row"><span class="flbl">Orden:</span>
  <button class="sort-btn ${S.sortKey==='profit'?S.sortDir:''}" data-sort="profit">Rentab. ${S.sortKey==='profit'?sa:'‚Üï'}</button>
  <button class="sort-btn ${S.sortKey==='time'?S.sortDir:''}" data-sort="time">Hora ${S.sortKey==='time'?sa:'‚Üï'}</button>
  <button class="arb-toggle ${S.showOnlyArb?'active':''}" id="arbBtn">Solo arb</button>
</div>
<div class="stake-row"><span class="stake-lbl">‚Ç¨</span>${[50,100,200,300,500].map(v=>`<button class="schip ${!S.isCustom&&S.stake===v?'active':''}" data-stake="${v}">${v}</button>`).join("")}<input class="sinp2 ${S.isCustom?'active':''}" id="custStake" type="number" min="1" max="500" placeholder="Otro" value="${S.customStake}"></div>
${S.events.length?`<div class="meta-row"><strong>${disp.length}</strong> de ${S.events.length}${S.showOnlyArb?" ¬∑ solo arb":""}</div>`:""}
<div class="content" id="evList">
  ${S.loading&&!S.events.length?skels(6):""}
  ${!S.loading&&!S.events.length&&!S.error?`<div class="empty"><div class="empty-icon">üì°</div><div class="empty-text">Pulsa <strong>Escanear</strong> para consultar cuotas de casas DGOJ</div></div>`:""}
  ${S.error&&!S.events.length?`<div class="empty"><div class="empty-icon">‚ö†Ô∏è</div><div class="empty-text" style="color:var(--red)">${S.error}</div><button class="btn-sm" id="retryBtn" style="margin-top:10px">Reintentar</button></div>`:""}
  ${disp.map(ev=>evCard(ev)).join("")}
</div>`}

function evCard(ev){
  const open=S.expanded===ev.id,ds=S.detailStakes[ev.id]??S.stake,mx=Math.max(...ev.legs.map(l=>l.odds));
  return`<div class="ev ${ev.isArb?'arb':''}" data-evid="${ev.id}"><div class="ev-bar"></div>
<div class="ev-head" data-exp="${ev.id}">
  <div class="ev-left"><div class="ev-meta"><span class="ev-tour">${ev.tournament}</span><span class="ev-sep">¬∑</span><span class="ev-time">${fmtTime(ev.commence)}</span><span class="ev-sep">¬∑</span><span style="font-size:8px;color:var(--muted)">${ev.bookCount} casas</span></div><div class="ev-match">${ev.match}</div><span class="ev-sport">${GICON[ev.group]||"üèÜ"} ${ev.sport}</span></div>
  <div class="ev-right">${ev.isArb?`<div class="badge-arb">+${ev.profit.toFixed(2)}%</div>`:`<div class="badge-none">Sin arb</div>`}<div class="ev-impl">Œ£ ${(ev.impliedSum*100).toFixed(1)}%</div></div>
  <div class="ev-chev ${open?'open':''}">‚ñº</div>
</div>
<div class="ev-odds">${ev.legs.map(l=>`<div class="oc ${ev.isArb&&l.odds===mx?'best':''}"><div class="oc-n">${l.label}</div><div class="oc-v">${parseFloat(l.odds).toFixed(2)}</div><div class="oc-b">${l.book}</div></div>`).join("")}</div>
${open?detailHTML(ev,ds):""}</div>`}

function detailHTML(ev,amt){
  const{sum,isArb,profit}=calcArb(ev.legs),legs=calcStakes(ev.legs,amt),net=isArb?+((amt/sum)-amt).toFixed(2):null;
  return`<div class="detail">
<div class="rbox ${isArb?'win':'lose'}">${isArb?`<div class="r-pct">+${profit.toFixed(2)}%</div><div class="r-info"><div class="r-tag">‚ú¶ Arbitraje</div><div class="r-profit">‚Ç¨${net} netos</div></div>`:`<div class="r-no">Sin arbitraje</div><div class="r-info"><div class="r-mg">Margen</div><div style="font-family:var(--display);font-size:13px;font-weight:700;color:var(--text2)">+${((sum-1)*100).toFixed(2)}%</div></div>`}</div>
<div class="inv-row"><span class="inv-lbl">Inversi√≥n (m√°x ‚Ç¨500)</span><span class="inv-e">‚Ç¨</span><input class="inv-i" type="number" min="1" max="500" value="${amt}" data-ds="${ev.id}"></div>
<div class="lgrid">${legs.map(l=>`<div class="lc"><div class="lc-top"><span class="lc-name">${l.label}</span><span class="lc-odds">${parseFloat(l.odds).toFixed(2)}</span></div><div class="lc-book">üìå ${l.book}</div><div class="lc-amts"><div class="la s"><div class="la-v">‚Ç¨${l.stake}</div><div class="la-l">Apostar</div></div><div class="la r"><div class="la-v">‚Ç¨${l.payout}</div><div class="la-l">Retorno</div></div></div>${l.allOpts?.length>1?`<div class="comp"><div class="comp-t">Comparativa</div>${l.allOpts.map((o,i)=>`<div class="comp-r ${i===0?'top':''}"><span class="comp-n">${o.book}</span><span class="comp-o">${parseFloat(o.odds).toFixed(2)}</span></div>`).join("")}</div>`:""}</div>`).join("")}</div>
${isArb?`<div class="ibox">üí° Œ£ ${(sum*100).toFixed(2)}% ‚Äî retorno <strong>‚Ç¨${(amt/sum).toFixed(2)}</strong> ¬∑ ${ev.bookCount} casas DGOJ</div>`:""}</div>`}

function renderCalc(){
  const legs=S.calcLegs,valid=legs.every(l=>l.odds&&parseFloat(l.odds)>1),arb=valid?calcArb(legs.map(l=>({...l,odds:parseFloat(l.odds)}))):null,ws=valid?calcStakes(legs.map(l=>({...l,odds:parseFloat(l.odds)})),S.calcStake):[];
  return`<div class="content"><div class="calc"><div class="calc-t">Calculadora manual</div>
${legs.map((l,i)=>`<div class="calc-card"><div class="calc-row"><div class="calc-f"><div class="calc-lbl">Resultado</div><input class="calc-inp" data-ci="${i}" data-cf="label" value="${l.label}"></div><div class="calc-f"><div class="calc-lbl">Casa</div><input class="calc-inp" data-ci="${i}" data-cf="book" value="${l.book}"></div></div><div class="calc-lbl">Cuota</div><input class="calc-oinp" type="number" step="0.01" min="1.01" placeholder="2.05" data-ci="${i}" data-cf="odds" value="${l.odds}"></div>`).join("")}
<div class="calc-btns"><button class="calc-btn calc-add" id="cAdd">+ A√±adir</button>${legs.length>2?`<button class="calc-btn calc-del" id="cDel">‚àí Quitar</button>`:""}</div>
<div class="inv-row" style="margin-bottom:14px"><span class="inv-lbl">Inversi√≥n</span><span class="inv-e">‚Ç¨</span><input class="inv-i" id="cStake" type="number" min="1" max="500" value="${S.calcStake}"></div>
${valid&&arb?(arb.isArb?`<div style="border-radius:var(--radius);padding:14px;margin-bottom:14px;background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.2)"><div style="font-family:var(--display);font-size:46px;font-weight:900;color:var(--accent);line-height:1">+${arb.profit.toFixed(2)}%</div><div style="font-size:10px;color:var(--accent);letter-spacing:2px;text-transform:uppercase;margin-top:5px">‚ú¶ Arbitraje ‚ú¶</div><div style="font-size:13px;color:var(--text);margin-top:6px">Beneficio: <strong>‚Ç¨${((S.calcStake/arb.sum)-S.calcStake).toFixed(2)}</strong></div></div>`:`<div style="border-radius:var(--radius);padding:12px;margin-bottom:14px;background:rgba(90,112,144,.06);border:1px solid var(--border)"><div style="font-family:var(--display);font-size:16px;font-weight:700;color:var(--text2)">Sin arb ‚Äî margen +${((arb.sum-1)*100).toFixed(2)}%</div></div>`):""}
${valid&&ws.length?`<div style="font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px">Distribuci√≥n</div><div class="lgrid">${ws.map(l=>`<div class="lc"><div class="lc-top"><span class="lc-name">${l.label}</span><span class="lc-odds">${parseFloat(l.odds).toFixed(2)}</span></div><div class="lc-book">üìå ${l.book}</div><div class="lc-amts"><div class="la s"><div class="la-v">‚Ç¨${l.stake}</div><div class="la-l">Apostar</div></div><div class="la r"><div class="la-v">‚Ç¨${l.payout}</div><div class="la-l">Retorno</div></div></div></div>`).join("")}</div>`:""}
${!valid?`<div class="empty" style="padding:30px"><div class="empty-icon">üßÆ</div><div class="empty-text">Introduce cuotas > 1.00</div></div>`:""}</div></div>`}

function renderTicker(){return`<div class="ticker"><div class="ticker-left"><div class="ticker-dot ${S.loading?'loading':'ok'}"></div><span id="tickTxt">${tickTxt()}</span></div><button class="auto-btn ${S.autoRefresh?'on':''}" id="autoBtn">Auto ${S.autoRefresh?"ON 2min":"OFF"}</button></div>`}

function skels(n){return Array.from({length:n}).map(()=>`<div class="sk"><div class="sk-l sk-s"></div><div class="sk-l sk-w"></div><div class="sk-l sk-m"></div><div class="sk-bx"><div class="sk-b"></div><div class="sk-b"></div><div class="sk-b"></div></div></div>`).join("")}

// ‚ïê‚ïê‚ïê BIND ‚ïê‚ïê‚ïê
function bindAll(){
  const $=id=>document.getElementById(id),$$=s=>document.querySelectorAll(s);
  const cb=$("connBtn");
  if(cb){const ki=$("keyInp");const go=async()=>{const key=ki.value.trim();if(!key)return;const eb=$("errBox");eb.style.display="none";cb.disabled=true;cb.textContent="Verificando‚Ä¶";S.diagLog=[];dlog("Verificando‚Ä¶");
    try{const r=await apiGet(`${API}/sports?apiKey=${key}`);
      if(r.status===401){
        // Check if it's really invalid key or quota exhausted
        let body="";try{body=await r.text()}catch{}
        const isQuota=body.toLowerCase().includes("usage")||body.toLowerCase().includes("quota")||body.toLowerCase().includes("exceeded");
        if(isQuota){dlog("‚úó Cuota agotada","err");eb.textContent="Tu cuota mensual est√° agotada. Renueva en the-odds-api.com o espera al pr√≥ximo ciclo.";eb.style.display="block";cb.disabled=false;cb.textContent="Conectar y Escanear";return}
        dlog("‚úó Key inv√°lida","err");eb.textContent="API key inv√°lida";eb.style.display="block";cb.disabled=false;cb.textContent="Conectar y Escanear";return}
      try{const rem=r.headers.get("x-requests-remaining"),used=r.headers.get("x-requests-used");if(rem)S.remaining=parseInt(rem);if(used)S.used=parseInt(used)}catch{}
      if(S.remaining!==null&&S.remaining<1){dlog(`‚úó Cuota agotada (${S.remaining} req)`,"err");eb.textContent=`Cuota agotada (${S.remaining} req restantes). Renueva en the-odds-api.com o espera al pr√≥ximo mes.`;eb.style.display="block";cb.disabled=false;cb.textContent="Conectar y Escanear";return}
      dlog(`‚úì Key OK${S.remaining!==null?' ¬∑ '+S.remaining+' req restantes':''}`,"ok");
      localStorage.setItem("arb_key",key);S.key=key;S.ok=true;render();fetchAll();startTimer();
    }catch(e){dlog("‚úó "+e.message,"err");eb.textContent="Error: "+e.message;eb.style.display="block";cb.disabled=false;cb.textContent="Conectar y Escanear"}};
    cb.onclick=go;ki.onkeydown=e=>{if(e.key==="Enter")go()}}
  const lb=$("logBtn");if(lb)lb.onclick=()=>{localStorage.removeItem("arb_key");sessionStorage.clear();Object.assign(S,{key:"",ok:false,events:[],error:null,remaining:null,used:null,lastFetch:null,allSportKeys:[]});if(S._timer)clearInterval(S._timer);render()};
  const rb=$("refBtn");if(rb)rb.onclick=()=>{S.loading?cancelFetch():fetchAll()};
  const rt=$("retryBtn");if(rt)rt.onclick=()=>fetchAll();
  $$("[data-tab]").forEach(b=>b.onclick=()=>{S.tab=b.dataset.tab;render()});
  $$("[data-mode]").forEach(b=>b.onclick=()=>{S.scanMode=b.dataset.mode;localStorage.setItem("arb_mode",S.scanMode);render()});
  $$("[data-sport]").forEach(b=>b.onclick=()=>{S.sportFilter=b.dataset.sport;render()});
  $$("[data-sort]").forEach(b=>b.onclick=()=>{if(S.sortKey===b.dataset.sort)S.sortDir=S.sortDir==="desc"?"asc":"desc";else{S.sortKey=b.dataset.sort;S.sortDir="desc"}render()});
  const ab=$("arbBtn");if(ab)ab.onclick=()=>{S.showOnlyArb=!S.showOnlyArb;render()};
  $$("[data-stake]").forEach(b=>b.onclick=()=>{S.stake=parseInt(b.dataset.stake);S.isCustom=false;S.customStake="";render()});
  const cs=$("custStake");if(cs)cs.oninput=e=>{S.customStake=e.target.value;S.isCustom=true;S.stake=Math.min(500,Math.max(1,parseFloat(e.target.value)||1))};
  $$("[data-exp]").forEach(el=>el.onclick=()=>{S.expanded=S.expanded===el.dataset.exp?null:el.dataset.exp;render()});
  $$("[data-ds]").forEach(inp=>inp.oninput=e=>{const id=e.target.dataset.ds;S.detailStakes[id]=Math.min(500,Math.max(1,parseFloat(e.target.value)||1));const ev=S.events.find(x=>x.id===id),c=document.querySelector(`[data-evid="${id}"] .detail`);if(ev&&c){c.outerHTML=detailHTML(ev,S.detailStakes[id]);bindAll()}});
  const atb=$("autoBtn");if(atb)atb.onclick=()=>{S.autoRefresh=!S.autoRefresh;if(S.autoRefresh)startTimer();render()};
  $$("[data-ci]").forEach(inp=>inp.oninput=e=>{const i=parseInt(e.target.dataset.ci),f=e.target.dataset.cf;S.calcLegs[i][f]=e.target.value;render();const el=document.querySelector(`[data-ci="${i}"][data-cf="${f}"]`);if(el){el.focus();el.setSelectionRange(el.value.length,el.value.length)}});
  const ca=$("cAdd");if(ca)ca.onclick=()=>{S.calcLegs.push({label:`Opci√≥n ${S.calcLegs.length+1}`,book:"Casa",odds:""});render()};
  const cd=$("cDel");if(cd)cd.onclick=()=>{if(S.calcLegs.length>2)S.calcLegs.pop();render()};
  const csi=$("cStake");if(csi)csi.oninput=e=>{S.calcStake=Math.min(500,Math.max(1,parseFloat(e.target.value)||1));render();const el=$("cStake");if(el){el.focus();el.setSelectionRange(el.value.length,el.value.length)}};
}

render();if(S.ok){fetchAll();startTimer()}
</script>
</body>
</html>
